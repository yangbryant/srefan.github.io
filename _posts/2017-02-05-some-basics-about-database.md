---
layout: post
title: 数据库系统的常识
date: 2017-02-05 15:47:59 +08:00
tags: 温故而知新
---

***

### 事务处理

* 事务来自于2个独立的需求: **并发数据库访问** 和 **系统错误恢复**.
* 一个事务可以被看作是 **一个单元的一系列SQL语句的集合**.

#### 事务特性 (A.C.I.D)

* A - 原子性 (Atomacity): 事务必须是原子工作单元,对于其数据修改,要么全都执行,要么全都不执行.
* C - 一致性 (Consistency): 事务将数据库从一种一致状态转变为下一种一致状态.
* I - 隔离性 (Isolation): 由并发事务所作的修改必须与任何其它并发事务所作的修改隔离.
* D - 持久性 (Durability): 事务完成之后,它对于系统的影响是永久性的.即使出现致命的系统故障也将一直保持.

#### 事务的隔离级别

* 不对数据库进行 **并发控制** ,会产生异常情况:
1. 脏读 (Dirty Read): 一个事务读取**另一个事务尚未提交的修改**产生脏读,同一事务内不是脏读. - 由于读取过程中,另一事务更新了数据没有及时提交造成的(数据可能被回滚).
2. 非重复读 (Nonrepeatable Read): 一个事务对**同一行数据重复读取两次**得到不同的结果. - 由于查询过程中,其他提交事务修改或删除数据造成的.
3. 幻像读 (Phantom Read): 事务在操作过程中进行**两次查询**,第二次查询结果包含第一次查询中未出现的数据(不要求两次查询的SQL语句相同). - 由于两次查询中,另一事务插入数据造成的.
4. 丢失修改 (Lost Update): a. 两个事物更新相同的数据源,第一个被提交,第二个被撤销,那么第一个做的更新也会被撤销. b. 两个并发事务同时读取同一行数据,第一个进行修改提交,第二个也进行修改提交,造成第一次写操作失效.

* 为了兼顾 **并发效率** 和 **异常控制**,标准SQL规范里定义了4个事务隔离级别:
1. 未提交读 (Read Uncommitted): 更新语句没有提交,别的事务可以读到改变数据. - 允许 **脏读**.
2. 已提交读 (Read Committed): 只能读取到已提交的数据. - 不允许 **脏读**, 允许 **非重复读**.(多数数据库默认该级别).
3. 可重复读 (Repeatable Read): 同一事务先后执行同一查询语句得到一样的结果. - 不允许 **脏读**,**非重复读**, 允许 **幻像读**.
4. 串行读 (Serializable): 串行化的读,当前事务执行时不允许别的事务并发进行.每次读需要获得 **表级共享锁**,读写都会阻塞. - 不允许 **不一致现象** 出现.
 
#### 事务隔离的实现 - 锁

* 共享锁(S锁): 用于只读操作(SELECT),锁定共享的资源. - 不阻止其他用户 **读**, 只阻止其他用户 **写**.
* 更新锁(U锁): 用于可更新的资源.防止多个会话读取,锁定,资源更新时发生死锁.
* 独立锁(X锁,排他锁): 一次只有一个独占锁用在一个资源上,阻止其他锁.写是独占锁,可有效的防止 **脏读**.

* Read Uncommited: 一个事务在**写数据**, 另外一事务则 **不允许** 同时进行 **写操作**, 但允许其他事务 **读数据**. 该隔离级别可以通过 **“排他写锁”** 实现.
* Read Committed **读取数据**的事务允许其他事务继续**访问该数据**; 但 **未提交的写事务** 会禁止 **其他事务访问该数据**. 可以通过 **“瞬间共享读锁”** 和 **“排他写锁”** 实现.
* Repeatable Read **读取数据**的事务 **禁止写事务**, 但 **允许读事务**, 写事务则**禁止任何其他事务**. 可以通过 **“共享读锁”** 和 **“排他写锁”** 实现.
* Serializable **读数据** 加 **共享锁**, **写数据** 加 **排他锁**, **读写互斥**.

***

### 索引

***

此文参考于 [hit-alibaba.github.io][hit-alibaba.github.io],十分感谢.  
所有引用内容版权归原作者所有.  
使用 [知识共享“署名-非商业性使用-相同方式共享 3.0 中国大陆”许可协议][Lisence] 授权.

[hit-alibaba.github.io]: https://hit-alibaba.github.io/interview/
[Lisence]: https://creativecommons.org/licenses/by-nc-sa/3.0/cn/